<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'strict-dynamic'; img-src 'self' data:; connect-src 'self' *;" />
  <title>CertNode — Verify Receipt</title>
  <link rel="stylesheet" href="assets/certnode.css" />
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between; align-items:center; margin:0">
      <h1>CertNode — Verify Receipt</h1>
      <div class="toolbar" style="margin:0">
        <button id="theme-toggle" title="Toggle theme">Theme</button>
      </div>
    </div>
  </header>
  <main>
    <section class="panel">
      <h2>Receipt JSON</h2>
      <div class="row grid-2">
        <div class="dropzone" id="receipt-drop">Drop receipt.json here</div>
        <div class="toolbar" style="justify-content:flex-end">
          <input type="file" id="receipt-file" accept="application/json" />
          <button id="receipt-sample">Load sample</button>
          <button id="receipt-format">Format</button>
          <button id="receipt-minify">Minify</button>
        </div>
      </div>
      <textarea id="receipt" placeholder='{"protected":"...","payload":{...},"signature":"...","kid":"..."}'></textarea>
    </section>

    <section class="panel">
      <h2>JWKS</h2>
      <div class="row grid-2">
        <div class="dropzone" id="jwks-drop">Drop jwks.json here</div>
        <div class="toolbar" style="justify-content:flex-end">
          <input type="file" id="jwks-file" accept="application/json" />
          <button id="jwks-format">Format</button>
          <button id="jwks-minify">Minify</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <input type="url" id="jwks-url" placeholder="Optional: https://.../.well-known/jwks.json" />
        <button id="fetch-jwks">Fetch</button>
      </div>
      <textarea id="jwks" placeholder='{"keys":[{"kty":"EC","crv":"P-256","x":"...","y":"...","kid":"..."}]}'></textarea>
      <div class="small muted">JWKS is cached locally in your browser for convenience.</div>
    </section>

    <section class="panel" style="grid-column: 1 / -1;">
      <h2>Verify</h2>
      <div class="row" style="gap:8px">
        <button id="verify">Verify</button>
        <button id="clear">Clear</button>
        <span class="small">Verification uses WebCrypto (ES256) via web/js/verify.js</span>
      </div>
      <div id="status" class="status" style="display:none"></div>
      <div style="margin-top:8px" class="grid-2">
        <div>
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 class="small" style="margin:0">Protected Header</h3>
            <button id="copy-hdr" class="pill">Copy</button>
          </div>
          <pre id="hdr"></pre>
        </div>
        <div>
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 class="small" style="margin:0">Result</h3>
            <button id="copy-result" class="pill">Copy</button>
          </div>
          <pre id="result"></pre>
        </div>
      </div>
    </section>
  </main>
  <footer>
    Paste or drop files above. For full offline verification, use the Node SDK or CLI in <code>tools/verify-receipt.js</code>.
  </footer>

  <script src="js/verify.js"></script>
  <script src="js/verify-helper.js"></script>
  <script type="module">
    import { JWKSManager } from '../sdk/web/jwks-manager.js';
    window.CertNode = window.CertNode || {};
    window.CertNode.JWKSManager = JWKSManager;
  </script>
  <script>
    const $ = (s) => document.querySelector(s);
    const LS_JWKS = 'certnode:jwks';
    const LS_RECEIPT = 'certnode:receipt';
    const LS_THEME = 'certnode:theme';

    const reasonMap = {
      missing_fields: 'Receipt missing required fields (protected, payload, signature, kid).',
      bad_protected: 'Protected header is not valid base64url‑encoded JSON.',
      unsupported_alg: 'Unsupported algorithm in header. Only ES256 (P‑256) is supported.',
      kid_mismatch: 'Key ID mismatch between protected header and receipt.',
      kid_not_found: 'Key not found in the provided JWKS (check kid/thumbprint).',
      payload_hash_mismatch: 'Payload hash mismatch (JCS) — receipt payload was modified or JCS mismatch.',
      signature_invalid: 'Signature verification failed — receipt may be invalid or JWKS incorrect.',
      receipt_id_mismatch: 'Receipt ID does not match computed value.',
      bad_receipt: 'Receipt must be a JSON object.',
      invalid_json: 'Invalid JSON provided.'
    };

    function setStatus(ok, msg) {
      const el = $('#status');
      el.style.display = 'block';
      el.className = 'status ' + (ok ? 'ok' : 'err');
      el.textContent = msg;
    }
    function clearAll() {
      $('#receipt').value = '';
      $('#jwks').value = '';
      $('#jwks-url').value = '';
      $('#result').textContent = '';
      $('#hdr').textContent = '';
      $('#status').style.display = 'none';
      localStorage.removeItem(LS_JWKS);
      localStorage.removeItem(LS_RECEIPT);
    }
    async function readFileToText(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(String(r.result || ''));
        r.onerror = (e) => rej(e);
        r.readAsText(file);
      });
    }
    function parseJsonSafe(s) {
      try { return JSON.parse(s); } catch { return null; }
    }
    function decodeHeaderB64u(protectedB64u) {
      try {
        const padded = protectedB64u + '='.repeat((4 - protectedB64u.length % 4) % 4);
        const base64 = padded.replace(/-/g, '+').replace(/_/g, '/');
        return JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(base64), c => c.charCodeAt(0))));
      } catch { return null; }
    }
    function formatTextarea(id) {
      const el = document.getElementById(id);
      const obj = parseJsonSafe(el.value);
      if (!obj) return setStatus(false, 'invalid_json');
      el.value = JSON.stringify(obj, null, 2);
    }
    function minifyTextarea(id) {
      const el = document.getElementById(id);
      const obj = parseJsonSafe(el.value);
      if (!obj) return setStatus(false, 'invalid_json');
      el.value = JSON.stringify(obj);
    }
    function copyText(text) {
      try { navigator.clipboard.writeText(text); } catch {}
    }

    // Drag & drop handlers
    function setupDrop(zoneId, targetTextarea) {
      const dz = document.getElementById(zoneId);
      dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('drag'); });
      dz.addEventListener('dragleave', () => { dz.classList.remove('drag'); });
      dz.addEventListener('drop', async (e) => {
        e.preventDefault(); dz.classList.remove('drag');
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (!f) return;
        try {
          const txt = await readFileToText(f);
          document.getElementById(targetTextarea).value = txt.trim();
          if (targetTextarea === 'jwks') localStorage.setItem(LS_JWKS, txt.trim());
          if (targetTextarea === 'receipt') localStorage.setItem(LS_RECEIPT, txt.trim());
        } catch (err) {
          setStatus(false, 'Failed to read file: ' + err.message);
        }
      });
    }

    setupDrop('receipt-drop', 'receipt');
    setupDrop('jwks-drop', 'jwks');

    // File inputs
    $('#receipt-file').addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const txt = await readFileToText(f);
      $('#receipt').value = txt;
      localStorage.setItem(LS_RECEIPT, txt);
    });
    $('#jwks-file').addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const txt = await readFileToText(f);
      $('#jwks').value = txt;
      localStorage.setItem(LS_JWKS, txt);
    });

    // Theme toggle
    (function initTheme(){
      const t = localStorage.getItem(LS_THEME) || 'dark';
      document.documentElement.setAttribute('data-theme', t);
      $('#theme-toggle').addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = cur === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem(LS_THEME, next);
      });
    })();

    // Fetch JWKS from URL (with JWKSManager)
    $('#fetch-jwks').addEventListener('click', async () => {
      const url = $('#jwks-url').value.trim();
      if (!url) return setStatus(false, 'Enter a JWKS URL');
      try {
        if (!window.CertNode || !window.CertNode.JWKSManager) throw new Error('JWKSManager unavailable');
        const mgr = new window.CertNode.JWKSManager({ ttlMs: 300000 });
        const jwks = await mgr.fetchFromUrl(url);
        const text = JSON.stringify(jwks, null, 2);
        $('#jwks').value = text;
        localStorage.setItem(LS_JWKS, text);
        setStatus(true, 'Fetched JWKS');
      } catch (e) {
        setStatus(false, 'Failed to fetch JWKS: ' + e.message);
      }
    });

    // Load sample
    $('#receipt-sample').addEventListener('click', () => {
      const sample = {
        protected: 'eyJhbGciOiJFUzI1NiIsImtpZCI6ImRlbW8ta2lkIn0',
        payload: { hello: 'world', n: 42 },
        signature: 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA',
        kid: 'demo-kid'
      };
      const txt = JSON.stringify(sample, null, 2);
      $('#receipt').value = txt;
      localStorage.setItem(LS_RECEIPT, txt);
    });

    // Format/minify buttons
    $('#receipt-format').addEventListener('click', () => formatTextarea('receipt'));
    $('#receipt-minify').addEventListener('click', () => minifyTextarea('receipt'));
    $('#jwks-format').addEventListener('click', () => formatTextarea('jwks'));
    $('#jwks-minify').addEventListener('click', () => minifyTextarea('jwks'));
    $('#copy-hdr').addEventListener('click', () => copyText($('#hdr').textContent));
    $('#copy-result').addEventListener('click', () => copyText($('#result').textContent));

    // Restore from localStorage
    (function restore() {
      const jwks = localStorage.getItem(LS_JWKS);
      const rcpt = localStorage.getItem(LS_RECEIPT);
      if (jwks) $('#jwks').value = jwks;
      if (rcpt) $('#receipt').value = rcpt;
    })();

    // Verify
    $('#verify').addEventListener('click', async () => {
      const btn = $('#verify');
      btn.disabled = true; btn.textContent = 'Verifying…';
      $('#result').textContent = '';
      $('#hdr').textContent = '';
      const receiptTxt = $('#receipt').value.trim();
      const jwksTxt = $('#jwks').value.trim();
      if (!receiptTxt || !jwksTxt) { setStatus(false, 'Provide both receipt and JWKS'); btn.disabled = false; btn.textContent = 'Verify'; return; }

      const receipt = parseJsonSafe(receiptTxt);
      const jwks = parseJsonSafe(jwksTxt);
      if (!receipt || !jwks) { setStatus(false, 'Invalid JSON in receipt or JWKS'); btn.disabled = false; btn.textContent = 'Verify'; return; }

      const header = decodeHeaderB64u(receipt.protected || '');
      if (header) $('#hdr').textContent = JSON.stringify(header, null, 2);

      try {
        // Quick check first
        if (window.CertNode && window.CertNode.quickCheck) {
          const qc = await window.CertNode.quickCheck(receipt);
          if (!qc.ok) { setStatus(false, `Quick check failed: ${qc.reason}`); btn.disabled = false; btn.textContent = 'Verify'; return; }
        }
        // Full WebCrypto verify
        const res = await window.CertNode.verifyReceipt(receipt, jwks);
        if (res && res.ok) {
          setStatus(true, 'Receipt valid');
          $('#result').textContent = JSON.stringify({ ok: true }, null, 2);
        } else {
          const reason = (res && res.reason) || 'signature_invalid';
          const friendly = reasonMap[reason] || reason;
          setStatus(false, 'Invalid: ' + friendly);
          $('#result').textContent = JSON.stringify({ ok: false, reason, message: friendly }, null, 2);
        }
      } catch (e) {
        const reason = e && e.message ? e.message : 'error';
        const friendly = reasonMap[reason] || String(reason);
        setStatus(false, 'Verification error: ' + friendly);
        $('#result').textContent = JSON.stringify({ ok: false, error: String(reason), message: friendly }, null, 2);
      }
      btn.disabled = false; btn.textContent = 'Verify';
    });

    $('#clear').addEventListener('click', clearAll);

    // Download result
    (function addDownload(){
      const btn = document.createElement('button');
      btn.textContent = 'Download Result';
      btn.id = 'download-result';
      document.querySelector('section.panel:last-of-type .row').appendChild(btn);
      btn.addEventListener('click', () => {
        const txt = $('#result').textContent.trim() || '{}';
        const blob = new Blob([txt], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'verify-result.json';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      });
    })();
  </script>
</body>
</html>
